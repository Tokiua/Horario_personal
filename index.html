<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nonualco Shop - Agenda Diaria</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PWA: Manifiesto y Service Worker -->
  <link rel="manifest" href="data:application/manifest+json,{
    'name': 'Nonualco Shop Agenda',
    'short_name': 'Agenda',
    'start_url': '.',
    'display': 'standalone',
    'background_color': '#f3f4f6',
    'theme_color': '#3b82f6',
    'icons': [
      {
        'src': 'https://via.placeholder.com/192',
        'sizes': '192x192',
        'type': 'image/png'
      }
    ]
  }">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-md mx-auto p-4">
    <h1 class="text-2xl font-bold text-center mb-4">Nonualco Shop - Agenda Diaria</h1>
    <p class="text-center text-gray-600 mb-4">Josué Raúl Pineda Santos</p>

    <!-- Agenda -->
    <div id="agenda" class="space-y-4"></div>

    <!-- Campo para interactuar con Grok -->
    <div class="mt-6">
      <h2 class="text-lg font-semibold">Habla con Grok</h2>
      <textarea id="grokInput" class="w-full p-2 border rounded" rows="4" placeholder="Ej: 'Añade subtarea para Trabajo en la app: Diseñar página de inicio'"></textarea>
      <button id="grokSubmit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Enviar</button>
      <p id="grokResponse" class="mt-2 text-gray-700"></p>
    </div>

    <!-- Planificación del día siguiente -->
    <div id="nextDayPlanner" class="mt-6 hidden">
      <h2 class="text-lg font-semibold">Planifica el Día Siguiente</h2>
      <div id="nextDayAgenda" class="space-y-4"></div>
    </div>
  </div>

  <script>
    // Agenda base (hoy y mañana)
    let todaySchedule = [
      { time: "6:00 - 6:30 AM", activity: "Levantarse, aseo personal, hacer la cama", subtasks: [] },
      { time: "6:30 - 7:00 AM", activity: "Desayuno tranquilo", subtasks: [] },
      { time: "7:00 - 8:00 AM", activity: "Limpieza del hogar o pequeñas reparaciones", subtasks: [] },
      { time: "8:00 - 10:00 AM", activity: "Trabajo en el desarrollo de la app/web", subtasks: [] },
      { time: "10:00 - 10:30 AM", activity: "Merienda saludable", subtasks: [] },
      { time: "10:30 - 12:30 PM", activity: "Continuar con trabajo en la app", subtasks: [] },
      { time: "12:30 - 1:30 PM", activity: "Almuerzo y pequeño descanso", subtasks: [] },
      { time: "1:30 - 2:30 PM", activity: "Uso del celular (redes, mensajes, entretenimiento moderado)", subtasks: [] },
      { time: "2:30 - 4:30 PM", activity: "Segunda sesión de trabajo o aprendizaje", subtasks: [] },
      { time: "4:30 - 5:00 PM", activity: "Merienda ligera", subtasks: [] },
      { time: "5:00 - 6:00 PM", activity: "Actividades personales o del hogar", subtasks: [] },
      { time: "6:00 - 7:00 PM", activity: "Cena", subtasks: [] },
      { time: "7:00 - 7:30 PM", activity: "Descanso y preparación para reunión", subtasks: [] },
      { time: "7:30 - 9:00 PM", activity: "Reuniones con equipo / temas importantes del negocio", subtasks: [], hasMeeting: null },
    ];
    let tomorrowSchedule = JSON.parse(JSON.stringify(todaySchedule)); // Copia inicial

    // Renderizar agenda de hoy
    const agendaDiv = document.getElementById("agenda");
    function renderTodayAgenda() {
      agendaDiv.innerHTML = "";
      todaySchedule.forEach((item, index) => {
        const block = document.createElement("div");
        block.className = "bg-white p-4 rounded shadow";
        let meetingButtons = "";
        if (item.activity.includes("Reuniones con equipo")) {
          meetingButtons = `
            <p class="mt-2">¿Toca reunión hoy?</p>
            <button onclick="setMeeting(${index}, true)" class="bg-green-500 text-white px-2 py-1 rounded mr-2">Sí</button>
            <button onclick="setMeeting(${index}, false)" class="bg-red-500 text-white px-2 py-1 rounded">No</button>
            <p class="text-sm mt-1">${item.hasMeeting === null ? "Pendiente" : item.hasMeeting ? "Reunión confirmada" : "Sin reunión, usa este tiempo para planificar"}</p>
          `;
        }
        block.innerHTML = `
          <p class="font-semibold">${item.time}</p>
          <p>${item.activity}</p>
          <div class="mt-2">
            <h3 class="text-sm font-medium">Subtareas:</h3>
            <ul id="subtasks-${index}" class="list-disc pl-5 text-sm"></ul>
            <input id="subtaskInput-${index}" class="w-full p-1 border rounded mt-2" placeholder="Añadir subtarea...">
            <button onclick="addSubtask(${index}, 'today')" class="mt-1 bg-green-500 text-white px-2 py-1 rounded text-sm">Añadir</button>
          </div>
          ${meetingButtons}
        `;
        agendaDiv.appendChild(block);
        updateSubtasks(index, "today");
      });
    }

    // Renderizar agenda de mañana (para planificación)
    const nextDayAgendaDiv = document.getElementById("nextDayAgenda");
    function renderTomorrowAgenda() {
      nextDayAgendaDiv.innerHTML = "";
      tomorrowSchedule.forEach((item, index) => {
        const block = document.createElement("div");
        block.className = "bg-white p-4 rounded shadow";
        block.innerHTML = `
          <p class="font-semibold">${item.time}</p>
          <p>${item.activity}</p>
          <div class="mt-2">
            <h3 class="text-sm font-medium">Subtareas:</h3>
            <ul id="tomorrow-subtasks-${index}" class="list-disc pl-5 text-sm"></ul>
            <input id="tomorrow-subtaskInput-${index}" class="w-full p-1 border rounded mt-2" placeholder="Añadir subtarea...">
            <button onclick="addSubtask(${index}, 'tomorrow')" class="mt-1 bg-green-500 text-white px-2 py-1 rounded text-sm">Añadir</button>
          </div>
        `;
        nextDayAgendaDiv.appendChild(block);
        updateSubtasks(index, "tomorrow");
      });
    }

    // Añadir subtarea
    window.addSubtask = function(index, type) {
      const schedule = type === "today" ? todaySchedule : tomorrowSchedule;
      const input = document.getElementById(`${type}-subtaskInput-${index}`);
      if (input.value.trim()) {
        schedule[index].subtasks.push(input.value.trim());
        updateSubtasks(index, type);
        input.value = "";
        saveSchedules();
      }
    };

    // Actualizar subtareas
    function updateSubtasks(index, type) {
      const schedule = type === "today" ? todaySchedule : tomorrowSchedule;
      const list = document.getElementById(`${type}-subtasks-${index}`);
      list.innerHTML = schedule[index].subtasks.map(task => `<li>${task}</li>`).join("");
    }

    // Gestionar reuniones
    window.setMeeting = function(index, hasMeeting) {
      todaySchedule[index].hasMeeting = hasMeeting;
      if (!hasMeeting) {
        todaySchedule[index].activity = "Planificación o aprendizaje";
        todaySchedule[index].subtasks = [];
      }
      renderTodayAgenda();
      saveSchedules();
    };

    // Guardar agendas
    function saveSchedules() {
      localStorage.setItem("todaySchedule", JSON.stringify(todaySchedule));
      localStorage.setItem("tomorrowSchedule", JSON.stringify(tomorrowSchedule));
    }

    // Cargar agendas
    function loadSchedules() {
      const todaySaved = localStorage.getItem("todaySchedule");
      const tomorrowSaved = localStorage.getItem("tomorrowSchedule");
      if (todaySaved) todaySchedule = JSON.parse(todaySaved);
      if (tomorrowSaved) tomorrowSchedule = JSON.parse(tomorrowSaved);
      renderTodayAgenda();
      renderTomorrowAgenda();
    }
    loadSchedules();

    // Rotar agendas al final del día
    function rotateSchedules() {
      const now = new Date();
      const midnight = new Date(now);
      midnight.setHours(24, 0, 0, 0);
      const timeUntilMidnight = midnight - now;
      setTimeout(() => {
        todaySchedule = JSON.parse(JSON.stringify(tomorrowSchedule));
        tomorrowSchedule = JSON.parse(JSON.stringify(todaySchedule)).map(item => ({
          ...item,
          subtasks: [],
          hasMeeting: item.activity.includes("Reuniones") ? null : undefined
        }));
        saveSchedules();
        renderTodayAgenda();
        renderTomorrowAgenda();
        scheduleNotifications();
        rotateSchedules(); // Programar para el próximo día
      }, timeUntilMidnight);
    }
    rotateSchedules();

    // Notificaciones y voz
    function requestNotificationPermission() {
      if (Notification.permission !== "granted") {
        Notification.requestPermission();
      }
    }

    function sendNotification(time, activity, subtasks) {
      if (Notification.permission === "granted") {
        const body = subtasks.length ? `${activity} (Subtareas: ${subtasks.join(", ")})` : activity;
        new Notification(`Nonualco Shop - ${time}`, {
          body,
          icon: "https://via.placeholder.com/32",
        });
        // Sonido fuerte
        const audio = new Audio("https://freesound.org/data/previews/316/316847_4939433-lq.mp3");
        audio.play();
        // Leer en voz alta
        const utterance = new SpeechSynthesisUtterance(`A las ${time}: ${body}`);
        utterance.lang = "es-ES";
        window.speechSynthesis.speak(utterance);
      }
    }

    // Programar notificaciones
    function scheduleNotifications() {
      const now = new Date();
      todaySchedule.forEach(item => {
        if (!item.activity.includes("Dormir")) { // Excluir dormir
          const [startTime] = item.time.split(" - ");
          const [hours, minutes, period] = startTime.match(/(\d+):(\d+)\s*(AM|PM)/).slice(1);
          let hour = parseInt(hours);
          if (period === "PM" && hour !== 12) hour += 12;
          if (period === "AM" && hour === 12) hour = 0;
          const taskTime = new Date(now);
          taskTime.setHours(hour, parseInt(minutes), 0, 0);

          if (taskTime > now) {
            const delay = taskTime - now;
            setTimeout(() => sendNotification(item.time, item.activity, item.subtasks), delay);
          }
        }
      });
    }
    requestNotificationPermission();
    scheduleNotifications();

    // Mostrar planificador de mañana a las 9:00 PM
    const nextDayPlanner = document.getElementById("nextDayPlanner");
    function checkPlannerTime() {
      const now = new Date();
      const hours = now.getHours();
      if (hours >= 21) { // 9:00 PM
        nextDayPlanner.classList.remove("hidden");
      } else {
        nextDayPlanner.classList.add("hidden");
      }
      setTimeout(checkPlannerTime, 60000); // Revisar cada minuto
    }
    checkPlannerTime();

    // Interacción con Grok (simulada)
    const grokInput = document.getElementById("grokInput");
    const grokSubmit = document.getElementById("grokSubmit");
    const grokResponse = document.getElementById("grokResponse");

    grokSubmit.addEventListener("click", () => {
      const input = grokInput.value.trim();
      if (input) {
        let response = "Entendido, Josué. ";
        if (input.includes("subtarea")) {
          const match = input.match(/para (.+): (.+)/);
          if (match) {
            const activity = match[1];
            const subtask = match[2];
            const indexToday = todaySchedule.findIndex(item => item.activity.toLowerCase().includes(activity.toLowerCase()));
            const indexTomorrow = tomorrowSchedule.findIndex(item => item.activity.toLowerCase().includes(activity.toLowerCase()));
            if (indexToday !== -1 && input.includes("hoy")) {
              todaySchedule[indexToday].subtasks.push(subtask);
              updateSubtasks(indexToday, "today");
              response += `Añadí la subtarea "${subtask}" a "${activity}" para hoy.`;
            } else if (indexTomorrow !== -1 && input.includes("mañana")) {
              tomorrowSchedule[indexTomorrow].subtasks.push(subtask);
              updateSubtasks(indexTomorrow, "tomorrow");
              response += `Añadí la subtarea "${subtask}" a "${activity}" para mañana.`;
            } else {
              response += `No encontré la actividad "${activity}" o no especificaste hoy/mañana.`;
            }
          }
        } else if (input.includes("recordatorios")) {
          response += `Agenda de hoy:\n${todaySchedule.map(item => `${item.time}: ${item.activity} ${item.subtasks.length ? "(Subtareas: " + item.subtasks.join(", ") + ")" : ""}`).join("\n")}`;
        } else {
          response += `Guardé tu instrucción: "${input}". Pídeme un resumen o más detalles cuando quieras.`;
        }
        grokResponse.textContent = response;
        saveSchedules();
        grokInput.value = "";
      }
    });

    // Service Worker para PWA (offline)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("data:application/javascript,addEventListener('install',()=>{self.skipWaiting()});addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});addEventListener('fetch',e=>{e.respondWith(fetch(e.request))});");
    }
  </script>
</body>
</html>